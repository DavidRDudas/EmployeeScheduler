window.markets&&Array.isArray(window.markets)||(window.markets=[],window.saveData()),window.addMarket=function(){const e=document.getElementById("newMarketName").value,t=document.getElementById("newMarketRegion").value;e&&t?window.markets.some((t=>t.name.toLowerCase()===e.toLowerCase()))?alert("This market already exists"):(window.markets.push({name:e,region:t}),window.saveData(),document.getElementById("newMarketName").value="",document.getElementById("newMarketRegion").value="",window.renderMarkets()):alert("Please fill in all fields")},window.renderMarkets=function(){const e=document.getElementById("marketList");if(!e)return;e.innerHTML='\n        <div class="markets-grid"></div>\n    ';const t=e.querySelector(".markets-grid"),n=Array.isArray(window.markets)?window.markets:[];window.currentSort&&window.applySorting(n),n.forEach((e=>{const n=document.createElement("div");n.className="market-item",n.innerHTML=`\n            <div class="market-header">\n                <h4>${e.name}</h4>\n            </div>\n            <div class="market-details">\n                <p><strong>Region:</strong> ${e.region}</p>\n            </div>\n            <div class="market-actions">\n                <button class="edit-btn" onclick="window.editMarket('${e.name}')">Edit</button>\n                <button class="delete-btn" onclick="window.deleteMarket('${e.name}')">Delete</button>\n                <button class="view-schedule-btn" onclick="window.viewMarketSchedule('${e.name}')">View Schedule</button>\n            </div>\n        `,t.appendChild(n)}))},window.deleteMarket=function(e){confirm("Are you sure you want to delete this market?")&&(window.markets=window.markets.filter((t=>t.name.toLowerCase()!==e.toLowerCase())),window.saveData(),window.renderMarkets())};let currentSort={field:null,direction:"asc"};window.sortMarkets=function(e){const t=document.getElementById("marketList");Array.from(t.querySelectorAll(".market-item"));currentSort.field===e?currentSort.direction="asc"===currentSort.direction?"desc":"asc":(currentSort.field=e,currentSort.direction="asc"),document.querySelectorAll(".sort-btn").forEach((t=>{const n=t.querySelector(".sort-icon");t.dataset.sort===e?n.innerHTML="asc"===currentSort.direction?"&uarr;":"&darr;":n.innerHTML="&updownarrow;"})),window.markets.sort(((t,n)=>{let r,a;switch(e){case"name":r=t.name,a=n.name;break;case"region":r=t.region,a=n.region}return"asc"===currentSort.direction?r<a?-1:r>a?1:0:r>a?-1:r<a?1:0})),window.renderMarkets()},window.applySorting=function(e){e.sort(((e,t)=>{let n,r;switch(window.currentSort){case"name":n=e.name,r=t.name;break;case"region":n=e.region,r=t.region}return n<r?window.sortAscending?-1:1:n>r?window.sortAscending?1:-1:0}))},document.addEventListener("DOMContentLoaded",(()=>{window.renderMarkets()})),window.filterMarkets=function(){const e=document.getElementById("searchMarketInput").value.toLowerCase(),t=document.getElementById("marketList");if(!t)return;t.querySelectorAll(".market-item").forEach((t=>{const n=t.querySelector("h4").textContent.toLowerCase(),r=t.querySelector("p").textContent.toLowerCase(),a=n.includes(e)||r.includes(e);t.style.display=a?"block":"none"}))};let currentEditMarket=null;window.editMarket=function(e){const t=window.markets.find((t=>t.name===e));if(!t)return;currentEditMarket=e;const n=document.getElementById("editMarketModal");document.getElementById("editMarketName").value=t.name,document.getElementById("editMarketRegion").value=t.region,n.style.display="flex"},document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("editMarketModal"),t=e.querySelector(".close-modal");t&&t.addEventListener("click",(function(){e.style.display="none"}));const n=e.querySelector(".cancel-btn");n&&n.addEventListener("click",(function(){e.style.display="none"})),window.addEventListener("click",(function(t){t.target===e&&(e.style.display="none")}));const r=document.getElementById("saveMarketEdit");r&&r.addEventListener("click",(function(){const t=document.getElementById("editMarketName").value,n=document.getElementById("editMarketRegion").value;if(!t||!n)return void alert("Please fill in all fields");if(t!==currentEditMarket&&window.markets.some((e=>e.name.toLowerCase()===t.toLowerCase())))return void alert("Market name already exists");const r=window.markets.findIndex((e=>e.name===currentEditMarket));-1!==r&&(window.markets[r]={name:t,region:n},Object.values(window.projects).forEach((e=>{e.market===currentEditMarket&&(e.market=t)})),Object.values(window.employees).forEach((e=>{e.market===currentEditMarket&&(e.market=t)})),window.saveData(),window.renderMarkets(),e.style.display="none")})),window.renderMarkets()})),window.viewMarketSchedule=function(e){const t=window.markets.find((t=>t.name===e));if(!t)return;const n=Object.entries(window.projects).filter((([t,n])=>n.market===e)).map((([e,t])=>({id:e,...t}))),r=window.scheduleData?window.scheduleData.filter((t=>{const n=window.projects[t.projectId];return n&&n.market===e})):[],a=document.createElement("div");a.className="modal",a.style.display="flex",a.innerHTML=`\n        <div class="modal-content">\n            <div class="modal-header">\n                <h3>Schedule: ${t.name}</h3>\n                <span class="close-modal">&times;</span>\n            </div>\n            <div class="modal-body">\n                <h4>Market Details</h4>\n                <p><strong>Name:</strong> ${t.name}</p>\n                <p><strong>Region:</strong> ${t.region}</p>\n                \n                <h4>Projects (${n.length})</h4>\n                ${n.length>0?`\n                    <table class="assignments-table">\n                        <thead>\n                            <tr>\n                                <th>Project ID</th>\n                                <th>Name</th>\n                                <th>Estimated Days</th>\n                                <th>Date Added</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                            ${n.map((e=>`\n                                <tr>\n                                    <td>${e.id}</td>\n                                    <td>${e.name}</td>\n                                    <td>${e.days}</td>\n                                    <td>${new Date(e.dateAdded).toLocaleDateString()}</td>\n                                </tr>\n                            `)).join("")}\n                        </tbody>\n                    </table>\n                `:"<p>No projects found in this market</p>"}\n\n                <h4>Assignments (${r.length})</h4>\n                ${r.length>0?`\n                    <table class="assignments-table">\n                        <thead>\n                            <tr>\n                                <th>Date Range</th>\n                                <th>Employee</th>\n                                <th>Project</th>\n                                <th>Market PM</th>\n                                <th>Type</th>\n                                <th>Actions</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                            ${r.map((e=>`\n                                <tr>\n                                    <td>${new Date(e.startDate).toLocaleDateString()} - ${new Date(e.endDate).toLocaleDateString()}</td>\n                                    <td>${e.employee}</td>\n                                    <td>${window.projects[e.projectId]?.name||"Unknown Project"}</td>\n                                    <td>${e.marketProjectManager}</td>\n                                    <td>${e.entryType}</td>\n                                    <td>\n                                        <button class="delete-assignment-btn" \n                                                data-start="${e.startDate}" \n                                                data-end="${e.endDate}"\n                                                data-project="${e.projectId}"\n                                                data-employee="${e.employee}">\n                                            Delete\n                                        </button>\n                                    </td>\n                                </tr>\n                            `)).join("")}\n                        </tbody>\n                    </table>\n                `:"<p>No assignments found for this market</p>"}\n            </div>\n        </div>\n    `,document.body.appendChild(a);a.querySelectorAll(".delete-assignment-btn").forEach((t=>{t.addEventListener("click",(function(){const t=this.getAttribute("data-start"),n=this.getAttribute("data-end"),r=this.getAttribute("data-project"),o=this.getAttribute("data-employee");if(confirm("Are you sure you want to delete this assignment?")){const d=window.scheduleData.findIndex((e=>e.projectId===r&&e.startDate===t&&e.endDate===n&&e.employee===o));if(-1!==d){window.scheduleData.splice(d,1),window.saveData();document.getElementById("calendar")&&window.renderCalendar(),a.remove(),window.viewMarketSchedule(e)}}}))}));a.querySelector(".close-modal").addEventListener("click",(()=>a.remove())),a.addEventListener("click",(e=>{e.target===a&&a.remove()}))},window.renderMarkets=function(){const e=document.getElementById("marketList");if(!e)return;e.innerHTML='\n        <div class="markets-grid"></div>\n    ';const t=e.querySelector(".markets-grid"),n=Array.isArray(window.markets)?window.markets:[];window.currentSort&&window.applySorting(n),n.forEach((e=>{const n=document.createElement("div");n.className="market-item",n.innerHTML=`\n            <div class="market-header">\n                <h4>${e.name}</h4>\n            </div>\n            <div class="market-details">\n                <p><strong>Region:</strong> ${e.region}</p>\n            </div>\n            <div class="market-actions">\n                <button class="edit-btn" onclick="window.editMarket('${e.name}')">Edit</button>\n                <button class="delete-btn" onclick="window.deleteMarket('${e.name}')">Delete</button>\n                <button class="schedule-btn" onclick="window.viewMarketSchedule('${e.name}')">View Schedule</button>\n            </div>\n        `,t.appendChild(n)}))};
