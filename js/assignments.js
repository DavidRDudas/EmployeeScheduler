function createConflictMessage(e,t,n){const o=e=>new Date(e+"T12:00:00").toLocaleDateString();let d=`Conflicts found for ${e[0].employee}:\n\n`;return d+=`Your new assignment: ${o(t.toISOString().split("T")[0])} - ${o(n.toISOString().split("T")[0])}\n\n`,d+="Conflicts with:\n\n",e.forEach((e=>{const t=window.projects[e.projectId]||{name:"Unknown Project"};d+=`- ${t.name}\n`,d+=`  ${o(e.startDate)} - ${o(e.endDate)}\n`,d+=`  Type: ${e.entryType}\n\n`})),d+="\nDo you want to continue anyway?",d}window.renderAssignments=function(){const e=document.getElementById("assignmentsList");e.innerHTML="",window.scheduleData||(window.scheduleData=[]);window.scheduleData.filter((e=>{const t=Object.values(window.employees).find((t=>t.name===e.employee));return t&&t.active})).forEach(((t,n)=>{const o=window.projects[t.projectId]||{name:"Unknown Project",color:"#ffffff"},d=Object.values(window.employees).find((e=>e.name===t.employee))||{color:"#ffffff"},a=document.createElement("tr"),r=new Date(t.startDate+"T12:00:00"),s=new Date(t.endDate+"T12:00:00");a.innerHTML=`\n            <td>${r.toLocaleDateString()} - ${s.toLocaleDateString()}</td>\n            <td style="background-color: ${d.color};">${t.employee}</td>\n            <td style="background-color: ${o.color};">${o.name}</td>\n            <td>${o.market||"N/A"}</td>\n            <td>${t.marketProjectManager||"N/A"}</td>\n            <td>${t.entryType}</td>\n            <td>\n                <button class="edit-btn" onclick="window.editAssignment(${n})">Edit</button>\n                <button class="delete-btn" onclick="window.deleteAssignment(${n})">Delete</button>\n            </td>\n        `,e.appendChild(a)}))},window.addAssignment=function(){const e=document.getElementById("startDate").value,t=document.getElementById("endDate").value,n=document.getElementById("employee").value,o=document.getElementById("projectId").dataset.id,d=document.getElementById("marketProjectManager").value,a=document.getElementById("entryType").value;if(!(e&&t&&n&&o&&d))return void alert("Please fill in all fields");const r=new Date(e+"T12:00:00"),s=new Date(t+"T12:00:00");if(s<r)return void alert("End date cannot be before start date");const i=window.scheduleData.filter((e=>{const t=new Date(e.startDate+"T12:00:00"),o=new Date(e.endDate+"T12:00:00");return e.employee===n&&(r>=t&&r<=o||s>=t&&s<=o||r<=t&&s>=o)}));if(i.length>0){const e=createConflictMessage(i,r,s);if(!confirm(e))return}window.scheduleData.push({startDate:r.toISOString().split("T")[0],endDate:s.toISOString().split("T")[0],employee:n,projectId:o,projectName:window.projects[o]?.name||"Unknown Project",marketProjectManager:d,entryType:a}),window.saveData(),window.renderAssignments(),window.renderCalendar(),document.getElementById("startDate").value="",document.getElementById("endDate").value="",document.getElementById("employee").value="",document.getElementById("projectId").value="",document.getElementById("marketProjectManager").value="",document.getElementById("entryType").value="work"},window.deleteAssignment=function(e){confirm("Are you sure you want to delete this assignment?")&&(window.scheduleData.splice(e,1),window.saveData(),window.renderAssignments())},window.filterAssignments=function(){const e=document.getElementById("searchAssignmentInput").value.toLowerCase(),t=document.getElementById("assignmentsList").getElementsByTagName("tr");Array.from(t).forEach((t=>{const n=t.textContent.toLowerCase();t.style.display=n.includes(e)?"":"none"}))};let currentSort={field:null,direction:"asc"};function setupEmployeeField(e){const t=document.getElementById(e),n=document.createElement("div");n.id=`${e}-search-results`,n.className="search-results-dropdown",t.parentNode.appendChild(n),t.addEventListener("input",(function(t){const o=t.target.value.toLowerCase();if(!o)return n.innerHTML="",void n.classList.remove("active");const d=Object.entries(window.employees).filter((([e,t])=>t.active&&(t.name.toLowerCase().includes(o)||t.role.toLowerCase().includes(o)||t.market.toLowerCase().includes(o)))).slice(0,5);d.length>0?(n.innerHTML=d.map((([t,n])=>`\n                    <div class="search-result-item" onclick="window.selectEmployee('${n.name}', '${e}')">\n                        <div>${n.name}</div>\n                        <div class="employee-details">${n.role} - ${n.market}</div>\n                    </div>\n                `)).join(""),n.classList.add("active")):(n.innerHTML='<div class="search-result-item">No matching employees found</div>',n.classList.add("active"))})),document.addEventListener("click",(function(e){t.contains(e.target)||n.contains(e.target)||n.classList.remove("active")}))}function getDatesInRange(e,t){const n=[];let o=new Date(e);const d=new Date(t);for(;o<=d;)n.push(o.toISOString().split("T")[0]),o.setDate(o.getDate()+1);return n}function setupProjectSearchForEdit(){const e=document.getElementById("editProjectId"),t=document.createElement("div");t.id="edit-project-search-results",t.className="search-results-dropdown",e.parentNode.appendChild(t),e.addEventListener("input",(function(e){const n=e.target.value.toLowerCase();if(!n)return t.innerHTML="",void t.classList.remove("active");const o=Object.entries(window.projects).filter((([e,t])=>t.name.toLowerCase().includes(n)||e.toLowerCase().includes(n)||t.market.toLowerCase().includes(n))).slice(0,5);o.length>0?(t.innerHTML=o.map((([e,t])=>`\n                    <div class="search-result-item" onclick="window.selectEditProject('${e}')">\n                        <div>${t.name}</div>\n                        <div class="project-details">ID: ${e} | Market: ${t.market}</div>\n                    </div>\n                `)).join(""),t.classList.add("active")):(t.innerHTML='<div class="search-result-item">No matching projects found</div>',t.classList.add("active"))})),document.addEventListener("click",(function(n){e.contains(n.target)||t.contains(n.target)||t.classList.remove("active")}))}window.sortAssignments=function(e){const t=document.getElementById("assignmentsList"),n=Array.from(t.getElementsByTagName("tr"));currentSort.field===e?currentSort.direction="asc"===currentSort.direction?"desc":"asc":(currentSort.field=e,currentSort.direction="asc"),document.querySelectorAll(".sort-btn").forEach((t=>{const n=t.querySelector(".sort-icon");t.dataset.sort===e?n.innerHTML="asc"===currentSort.direction?"&uarr;":"&darr;":n.innerHTML="&updownarrow;"})),n.sort(((t,n)=>{let o,d;switch(e){case"date":o=new Date(t.cells[0].textContent.split("-")[0].trim()),d=new Date(n.cells[0].textContent.split("-")[0].trim());break;case"employee":o=t.cells[1].textContent,d=n.cells[1].textContent;break;case"project":o=t.cells[2].textContent,d=n.cells[2].textContent}return"date"===e?"asc"===currentSort.direction?o.getTime()-d.getTime():d.getTime()-o.getTime():"asc"===currentSort.direction?o<d?-1:o>d?1:0:o>d?-1:o<d?1:0})),t.innerHTML="",n.forEach((e=>t.appendChild(e)))},window.setupEmployeeSearch=function(){setupEmployeeField("employee"),setupEmployeeField("marketProjectManager")},window.selectEmployee=function(e,t){document.getElementById(t).value=e,document.getElementById(`${t}-search-results`).classList.remove("active")},window.setupProjectSearch=function(){const e=document.getElementById("projectId"),t=document.createElement("div");t.id="project-search-results",t.className="search-results-dropdown",e.parentNode.appendChild(t),e.addEventListener("input",(function(e){const n=e.target.value.toLowerCase();if(!n)return t.innerHTML="",void t.classList.remove("active");const o=Object.entries(window.projects).filter((([e,t])=>t.name.toLowerCase().includes(n)||e.toLowerCase().includes(n)||t.market.toLowerCase().includes(n))).slice(0,5);o.length>0?(t.innerHTML=o.map((([e,t])=>`\n                    <div class="search-result-item" onclick="window.selectProject('${e}')">\n                        <div>${t.name}</div>\n                        <div class="project-details">ID: ${e} | Market: ${t.market}</div>\n                    </div>\n                `)).join(""),t.classList.add("active")):(t.innerHTML='<div class="search-result-item">No matching projects found</div>',t.classList.add("active"))})),document.addEventListener("click",(function(n){e.contains(n.target)||t.contains(n.target)||t.classList.remove("active")}))},window.selectProject=function(e){const t=window.projects[e];document.getElementById("projectId").value=t.name,document.getElementById("projectId").dataset.id=e,document.getElementById("project-search-results").classList.remove("active")},document.addEventListener("DOMContentLoaded",(function(){const e=document.querySelector(".form-grid");e&&(e.innerHTML='\n            <div class="date-range">\n                <input type="date" id="startDate" required>\n                <span>to</span>\n                <input type="date" id="endDate" required>\n            </div>\n            <div class="employee-search-container">\n                <input type="text" id="employee" placeholder="Search employee..." autocomplete="off" required>\n                <div id="employee-search-results" class="search-results-dropdown"></div>\n            </div>\n            <div class="project-search-container">\n                <input type="text" id="projectId" placeholder="Search project..." autocomplete="off" required>\n                <div id="project-search-results" class="search-results-dropdown"></div>\n            </div>\n            <div class="employee-search-container">\n                <input type="text" id="marketProjectManager" placeholder="Search Market PM..." autocomplete="off" required>\n                <div id="marketProjectManager-search-results" class="search-results-dropdown"></div>\n            </div>\n            <select id="entryType" required>\n                <option value="work">Work</option>\n                <option value="pto">PTO</option>\n            </select>\n            <button onclick="window.addAssignment()" class="add-btn">Add Assignment</button>\n        '),window.setupEmployeeSearch(),window.setupProjectSearch(),window.renderAssignments()})),window.editAssignment=function(e){const t=window.scheduleData[e];if(!t)return;const n=document.getElementById("editAssignmentModal");n.style.display="flex",document.getElementById("editStartDate").value=t.startDate,document.getElementById("editEndDate").value=t.endDate,document.getElementById("editEmployee").value=t.employee,document.getElementById("editProjectId").value=window.projects[t.projectId]?.name||"",document.getElementById("editProjectId").dataset.id=t.projectId,document.getElementById("editMarketProjectManager").value=t.marketProjectManager,document.getElementById("editEntryType").value=t.entryType,n.dataset.editIndex=e,setupEmployeeField("editEmployee"),setupEmployeeField("editMarketProjectManager"),setupProjectSearchForEdit()},document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("editAssignmentModal");if(e){const t=e.querySelector(".close-modal");t&&t.addEventListener("click",(function(){e.style.display="none"}));const n=e.querySelector(".cancel-btn");n&&n.addEventListener("click",(function(){e.style.display="none"})),window.addEventListener("click",(function(t){t.target===e&&(e.style.display="none")}));const o=e.querySelector(".save-btn");o&&o.addEventListener("click",(function(){const t=parseInt(e.dataset.editIndex),n=document.getElementById("editStartDate").value,o=document.getElementById("editEndDate").value,d=document.getElementById("editEmployee").value,a=document.getElementById("editProjectId").dataset.id,r=document.getElementById("editMarketProjectManager").value,s=document.getElementById("editEntryType").value;if(!(n&&o&&d&&a&&r))return void alert("Please fill in all fields");const i=new Date(n+"T12:00:00"),c=new Date(o+"T12:00:00");if(c<i)return void alert("End date cannot be before start date");const l=window.scheduleData.filter(((e,n)=>{if(n===t)return!1;const o=new Date(e.startDate+"T12:00:00"),a=new Date(e.endDate+"T12:00:00");return e.employee===d&&(i>=o&&i<=a||c>=o&&c<=a||i<=o&&c>=a)}));if(l.length>0){const e=createConflictMessage(l,i,c);if(!confirm(e))return}window.scheduleData[t]={startDate:i.toISOString().split("T")[0],endDate:c.toISOString().split("T")[0],employee:d,projectId:a,projectName:window.projects[a]?.name||"Unknown Project",marketProjectManager:r,entryType:s},window.saveData(),window.renderAssignments(),"function"==typeof window.renderCalendar&&window.renderCalendar(),e.style.display="none"}))}})),window.selectEditProject=function(e){const t=window.projects[e];document.getElementById("editProjectId").value=t.name,document.getElementById("editProjectId").dataset.id=e,document.getElementById("edit-project-search-results").classList.remove("active")};
