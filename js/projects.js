let currentEditId=null,currentSort={field:null,direction:"asc"};function getDaysStatusColor(e,t){return t<e?"#4CAF50":t===e?"#007bff":"#dc3545"}window.addProject=function(){const e=document.getElementById("newProjectId").value,t=document.getElementById("newProjectName").value,n=document.getElementById("newProjectDays").value,o=document.getElementById("newProjectMarket").value,d=document.getElementById("newProjectColor").value;e&&t&&n&&o?window.projects[e]?alert("A project with this ID already exists"):(window.projects[e]={name:t,days:parseInt(n),market:o,color:d||"#4CAF50",dateAdded:(new Date).toISOString()},window.saveData(),window.renderProjects(),document.getElementById("newProjectId").value="",document.getElementById("newProjectName").value="",document.getElementById("newProjectDays").value="",document.getElementById("newProjectMarket").value="",document.getElementById("newProjectColor").value="#4CAF50"):alert("Please fill in all fields")},window.renderProjects=function(){const e=document.getElementById("projectList");e.innerHTML="",Object.entries(window.projects).forEach((([t,n])=>{const o=(window.scheduleData?window.scheduleData.filter((e=>e.projectId===t)):[]).reduce(((e,t)=>{const n=new Date(t.startDate+"T12:00:00"),o=new Date(t.endDate+"T12:00:00");return e+(Math.ceil((o-n)/864e5)+1)}),0),d=document.createElement("div");d.className="project-card",d.style.borderLeft=`4px solid ${n.color||"#4CAF50"}`,d.innerHTML=`\n            <div class="project-header">\n                <h4>${n.name}</h4>\n                <div class="project-color" style="background-color: ${n.color||"#4CAF50"}"></div>\n            </div>\n            <div class="project-details">\n                <p><strong>ID:</strong> ${t}</p>\n                <p><strong>Market:</strong> ${n.market}</p>\n                <p class="days-status" style="color: ${getDaysStatusColor(n.days,o)}">\n                    <strong>Days:</strong> ${o}/${n.days} \n                    (${o<n.days?"Under":o>n.days?"Over":"On"} Budget)\n                </p>\n            </div>\n            <div class="project-actions">\n                <button onclick="window.editProject('${t}')" class="edit-btn">Edit</button>\n                <button onclick="window.deleteProject('${t}')" class="delete-btn">Delete</button>\n                <button onclick="window.viewProjectSchedule('${t}')" class="schedule-btn">View Schedule</button>\n            </div>\n        `,e.appendChild(d)}))},window.deleteProject=function(e){confirm("Are you sure you want to delete this project?")&&(delete window.projects[e],window.saveData(),window.renderProjects())},window.filterProjects=function(){const e=document.getElementById("searchProjectInput").value.toLowerCase(),t=document.getElementById("projectList");Array.from(t.children).forEach((t=>{const n=t.querySelector("h4").textContent.toLowerCase(),o=t.querySelector(".project-details p:nth-child(1)").textContent.toLowerCase(),d=t.querySelector(".project-details p:nth-child(2)").textContent.toLowerCase(),r=n.includes(e)||o.includes(e)||d.includes(e);t.style.display=r?"block":"none"}))},window.sortProjects=function(e){const t=document.getElementById("projectList"),n=Array.from(t.children);currentSort.field===e?currentSort.direction="asc"===currentSort.direction?"desc":"asc":(currentSort.field=e,currentSort.direction="asc"),document.querySelectorAll(".sort-btn").forEach((t=>{const n=t.querySelector(".sort-icon");t.dataset.sort===e?n.innerHTML="asc"===currentSort.direction?"&uarr;":"&darr;":n.innerHTML="&updownarrow;"})),n.sort(((t,n)=>{let o,d;switch(e){case"name":o=t.querySelector("h4").textContent,d=n.querySelector("h4").textContent;break;case"market":o=t.querySelector(".project-details p:nth-child(2)").textContent.split(":")[1].trim(),d=n.querySelector(".project-details p:nth-child(2)").textContent.split(":")[1].trim();break;case"days":o=parseInt(t.querySelector(".project-details p:nth-child(3)").textContent.split(":")[1].trim()),d=parseInt(n.querySelector(".project-details p:nth-child(3)").textContent.split(":")[1].trim())}return"asc"===currentSort.direction?o<d?-1:o>d?1:0:o>d?-1:o<d?1:0})),t.innerHTML="",n.forEach((e=>t.appendChild(e)))},document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("editModal"),t=e.querySelector(".close-modal");t&&t.addEventListener("click",(function(){e.classList.remove("show")}));const n=e.querySelector(".cancel-btn");n&&n.addEventListener("click",(function(){e.classList.remove("show")})),window.addEventListener("click",(function(t){t.target===e&&e.classList.remove("show")}));const o=document.getElementById("saveProjectEdit");o&&o.addEventListener("click",(function(){const e=currentEditId,t=document.getElementById("editProjectId").value,n=document.getElementById("editProjectName").value,o=document.getElementById("editProjectDays").value,d=document.getElementById("editProjectMarket").value;if(!(t&&n&&o&&d))return void alert("Please fill in all fields");if(t!==e&&window.projects[t])return void alert("Project ID already exists");const r={name:n,days:parseInt(o),market:d,dateAdded:window.projects[e].dateAdded};t!==e?(window.scheduleData&&window.scheduleData.forEach((o=>{o.projectId===e&&(o.projectId=t,o.projectName=n)})),delete window.projects[e],window.projects[t]=r):(window.projects[e]=r,window.scheduleData&&window.scheduleData.forEach((t=>{t.projectId===e&&(t.projectName=n)}))),window.saveData(),window.renderProjects();document.getElementById("editModal").style.display="none";document.getElementById("calendar")&&window.renderCalendar()})),window.renderProjects(),window.setupMarketSearch("newProjectMarket"),window.setupMarketSearch("editProjectMarket")})),window.viewProjectSchedule=function(e){const t=window.projects[e];if(!t)return;const n=window.scheduleData?window.scheduleData.filter((t=>t.projectId===e)):[],o=n.reduce(((e,t)=>{const n=new Date(t.startDate+"T12:00:00"),o=new Date(t.endDate+"T12:00:00");return e+(Math.ceil((o-n)/864e5)+1)}),0),d=o-t.days,r=d>0?"over":d<0?"under":"match",c=document.createElement("div");c.className="modal",c.style.display="flex",c.innerHTML=`\n        <div class="modal-content">\n            <div class="modal-header">\n                <h3>Schedule: ${t.name}</h3>\n                <span class="close-modal">&times;</span>\n            </div>\n            <div class="modal-body">\n                <div class="project-summary">\n                    <h4>Project Details</h4>\n                    <p><strong>ID:</strong> ${e}</p>\n                    <p><strong>Market:</strong> ${t.market}</p>\n                    <p><strong>Estimated Days:</strong> ${t.days}</p>\n                    <p><strong>Total Assigned Days:</strong> ${o}</p>\n                    <p style="color: ${{over:"#dc3545",under:"#28a745",match:"#007bff"}[r]}">\n                        <strong>Status:</strong> \n                        ${"match"===r?"Assigned days match estimate exactly":`Project is ${Math.abs(d)} days ${r} estimate`}\n                    </p>\n                </div>\n                \n                <h4>Assignments (${n.length})</h4>\n                ${n.length>0?`\n                    <table class="assignments-table">\n                        <thead>\n                            <tr>\n                                <th>Date Range</th>\n                                <th>Employee</th>\n                                <th>Days</th>\n                                <th>Market PM</th>\n                                <th>Type</th>\n                                <th>Actions</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                            ${n.map((e=>{const t=new Date(e.startDate+"T12:00:00"),n=new Date(e.endDate+"T12:00:00"),o=Math.ceil((n-t)/864e5)+1;return`\n                                    <tr>\n                                        <td>${t.toLocaleDateString()} - ${n.toLocaleDateString()}</td>\n                                        <td>${e.employee}</td>\n                                        <td>${o}</td>\n                                        <td>${e.marketProjectManager}</td>\n                                        <td>${e.entryType}</td>\n                                        <td>\n                                            <button class="delete-assignment-btn" \n                                                    data-start="${e.startDate}" \n                                                    data-end="${e.endDate}"\n                                                    data-employee="${e.employee}">\n                                                Delete\n                                            </button>\n                                        </td>\n                                    </tr>\n                                `})).join("")}\n                        </tbody>\n                    </table>\n                `:"<p>No assignments found for this project</p>"}\n            </div>\n        </div>\n    `,document.body.appendChild(c);c.querySelectorAll(".delete-assignment-btn").forEach((t=>{t.addEventListener("click",(function(){const t=this.getAttribute("data-start"),n=this.getAttribute("data-end"),o=this.getAttribute("data-employee");if(confirm("Are you sure you want to delete this assignment?")){const d=window.scheduleData.findIndex((d=>d.projectId===e&&d.startDate===t&&d.endDate===n&&d.employee===o));if(-1!==d){window.scheduleData.splice(d,1),window.saveData();document.getElementById("calendar")&&window.renderCalendar();const t=this.closest("tr");if(t){t.remove();const n=c.querySelector("h4"),o=window.scheduleData.filter((t=>t.projectId===e)).length;n.textContent=`Assignments (${o})`;if(!c.querySelector("tbody").children.length){const e=c.querySelector(".assignments-table"),t=document.createElement("p");t.textContent="No assignments found for this project",e.replaceWith(t)}}}}}))}));c.querySelector(".close-modal").addEventListener("click",(()=>c.remove())),c.addEventListener("click",(e=>{e.target===c&&c.remove()}))},window.setupMarketSearch=function(e){const t=document.getElementById(e),n=document.createElement("div");n.id=`${e}-search-results`,n.className="search-results-dropdown",t.parentNode.appendChild(n),t.addEventListener("input",(function(t){const o=t.target.value.toLowerCase();if(!o)return n.innerHTML="",void n.classList.remove("active");const d=window.markets.filter((e=>e.name.toLowerCase().includes(o)||e.region.toLowerCase().includes(o))).slice(0,5);d.length>0?(n.innerHTML=d.map((t=>`\n                    <div class="search-result-item" onclick="window.selectMarket('${t.name}', '${e}')">\n                        <div>${t.name}</div>\n                        <div class="market-details">${t.region}</div>\n                    </div>\n                `)).join(""),n.classList.add("active")):(n.innerHTML='<div class="search-result-item">No matching markets found</div>',n.classList.add("active"))})),document.addEventListener("click",(function(e){t.contains(e.target)||n.contains(e.target)||n.classList.remove("active")}))},window.selectMarket=function(e,t){document.getElementById(t).value=e,document.getElementById(`${t}-search-results`).classList.remove("active")},window.editProject=function(e){const t=window.projects[e];if(!t)return;const n=document.getElementById("editModal");n.style.display="flex",currentEditId=e,document.getElementById("editProjectId").value=e,document.getElementById("editProjectName").value=t.name,document.getElementById("editProjectDays").value=t.days,document.getElementById("editProjectMarket").value=t.market,document.getElementById("editProjectColor").value=t.color||"#4CAF50";const o=document.getElementById("saveProjectEdit");o.replaceWith(o.cloneNode(!0)),document.getElementById("saveProjectEdit").onclick=function(){const e=document.getElementById("editProjectId").value,o={name:document.getElementById("editProjectName").value,days:parseInt(document.getElementById("editProjectDays").value),market:document.getElementById("editProjectMarket").value,color:document.getElementById("editProjectColor").value,dateAdded:t.dateAdded};if(o.name&&o.days&&o.market){if(e!==currentEditId){if(window.projects[e])return alert("A project with this ID already exists"),void(document.getElementById("editProjectId").value=currentEditId);window.scheduleData&&window.scheduleData.forEach((t=>{t.projectId===currentEditId&&(t.projectId=e,t.projectName=o.name)})),delete window.projects[currentEditId]}window.projects[e]=o,window.saveData(),window.renderProjects(),n.style.display="none",window.dispatchEvent(new Event("colorPreferenceChanged"))}else alert("Please fill in all required fields")};n.querySelector(".close-modal").onclick=()=>n.style.display="none";n.querySelector(".cancel-btn").onclick=()=>n.style.display="none",n.onclick=e=>{e.target===n&&(n.style.display="none")}};
